---
import { formatDistanceToNow } from 'date-fns';
import { getHumidity } from '../../lib/agent-db';
import OptimalityCard from '../conquer/optimality-card.tsx';

// Call the database function directly - no HTTP request needed!
const row = await getHumidity('studioSerial');

const humidity = row?.value ?? 50; // Fallback to 50 if no data
const recorded = row?.recorded ?? new Date();
1;
const utcDate = new Date(
  typeof recorded === 'string' ? recorded + (recorded.endsWith('Z') ? '' : 'Z') : recorded,
);

const optimality = (
  humidity >= 40 && humidity <= 60 ? 'optimal' : humidity < 40 ? 'lower' : 'higher'
) as 'optimal' | 'lower' | 'higher';

const data = {
  label: 'Humidity',
  description: `Bedroom Â· ${formatDistanceToNow(utcDate, { addSuffix: true })}`,
  value: `${humidity}%`,
  statusLabel: humidity < 40 ? 'Too Dry' : humidity > 60 ? 'Mold Risk' : 'Optimal',
  optimality,
  ranges: [
    {
      label: 'Too Dry',
      color: 'bg-red-500',
      min: 0,
      max: 40,
      ...(humidity < 40 && { progress: humidity / 40 }),
    },
    {
      label: 'Optimal',
      color: 'bg-green-500',
      min: 40,
      max: 60,
      ...(humidity >= 40 &&
        humidity <= 60 && {
          progress: (humidity - 40) / 20,
        }),
    },
    {
      label: 'Mold Risk',
      color: 'bg-red-500',
      min: 60,
      max: 100,
      ...(humidity > 60 && {
        progress: (humidity - 60) / 40,
      }),
    },
  ],
};
---

<OptimalityCard {...data} client:load />
