---
import { formatDistanceToNow } from 'date-fns';
import OptimalityCard from '../conquer/optimality-card.tsx';

// Use absolute URL for SSR fetch (Astro.url gives you the request URL)
const baseUrl = Astro.url.origin || 'http://localhost:4321';
const response = await fetch(`${baseUrl}/api/db/airthings/humidity`).then((r) => r.json());

const humidity = response.data.humidity;
const utcDate = new Date(
  response.data.recorded + (response.data.recorded.endsWith('Z') ? '' : 'Z'),
);

// Use 'as const' to get proper literal types
const optimality = (
  humidity >= 40 && humidity <= 60 ? 'optimal' : humidity < 40 ? 'lower' : 'higher'
) as 'optimal' | 'lower' | 'higher';

const data = {
  label: 'Humidity',
  description: `Bedroom Â· ${formatDistanceToNow(utcDate, { addSuffix: true })}`,
  value: `${humidity}%`,
  statusLabel: humidity < 40 ? 'Too Dry' : humidity > 60 ? 'Mold Risk' : 'Optimal',
  optimality,
  ranges: [
    {
      label: 'Too Dry',
      color: 'bg-red-500',
      min: 0,
      max: 40,
      ...(humidity < 40 && { progress: humidity / 40 }),
    },
    {
      label: 'Optimal',
      color: 'bg-green-500',
      min: 40,
      max: 60,
      ...(humidity >= 40 &&
        humidity <= 60 && {
          progress: (humidity - 40) / 20,
        }),
    },
    {
      label: 'Mold Risk',
      color: 'bg-red-500',
      min: 60,
      max: 100,
      ...(humidity > 60 && {
        progress: (humidity - 60) / 40,
      }),
    },
  ],
};
---

<OptimalityCard {...data} client:load />
