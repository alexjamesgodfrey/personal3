---
import { formatDistanceToNow } from 'date-fns';
import { getHumidity } from '../../lib/agent-db';
import OptimalityCard from '../conquer/optimality-card.tsx';
import Icon from '../icon-sprite';

// Call the database function directly - no HTTP request needed!
const row = await getHumidity('studioSerial');

const humidity = row?.value ?? 50; // Fallback to 50 if no data
const recorded = row?.recorded ?? new Date();
1;
const utcDate = new Date(
  typeof recorded === 'string' ? recorded + (recorded.endsWith('Z') ? '' : 'Z') : recorded,
);

const optimality = (
  humidity >= 40 && humidity <= 60 ? 'optimal' : humidity < 40 ? 'lower' : 'higher'
) as 'optimal' | 'lower' | 'higher';

const data = {
  label: 'Humidity',
  description: `Bedroom · ${formatDistanceToNow(utcDate, { addSuffix: true })}`,
  value: `${humidity}%`,
  statusLabel: humidity < 40 ? 'Too Dry' : humidity > 60 ? 'Mold Risk' : 'Optimal',
  optimality,
  ranges: [
    {
      label: 'Too Dry',
      color: 'bg-red-500',
      min: 0,
      max: 40,
      ...(humidity < 40 && { progress: humidity / 40 }),
    },
    {
      label: 'Optimal',
      color: 'bg-green-500',
      min: 40,
      max: 60,
      ...(humidity >= 40 &&
        humidity <= 60 && {
          progress: (humidity - 40) / 20,
        }),
    },
    {
      label: 'Mold Risk',
      color: 'bg-red-500',
      min: 60,
      max: 100,
      ...(humidity > 60 && {
        progress: (humidity - 60) / 40,
      }),
    },
  ],
};
---

<div class="flex flex-col justify-between">
  <OptimalityCard {...data} client:load />
  <div class="flex gap-2 font-mono px-2 text-sm">
    <p>Live Data via ChatDB Airthings Integration</p>
    <p>• UI from 121</p>
    <a href="/blog/chatdb-airthings" class="flex items-center gap-1 hover:underline">
      <p>• How it works</p>
      <Icon name="arrowUpRight" className="size-4" />
    </a>
  </div>
</div>
