---
import Altum from '../components/work/altum.astro';
import OneTwentyOne from '../components/work/onetwentyone.astro';
import Layout from '@alexgodfrey/web/layouts/BaseLayout.astro';
import BlogPreviewCard from '../components/blog-preview-card.astro';
import SHV from '../components/work/shv.astro';
import { ContactPopup } from '../components/contact-popup';
import { ContactPopupTrigger } from '../components/contact-popup-trigger';
import Co2Card from '../components/grid/airthings/co2.astro';
import HumidityCard from '../components/grid/airthings/humidity.astro';
import RadonCard from '../components/grid/airthings/radon.astro';
import BenjiQuote from '../components/grid/benji-quote.astro';
import CellPaintVideo from '../components/grid/cellpaint-video.astro';
import { HumanOrMachine } from '../components/human-or-machine';
import Icon from '../components/icon-sprite';
import { Logo, Logos } from '../components/utilities/logo';
import { WorkPopupTrigger } from '../components/work-popup-trigger';
import { ProfilePopup } from '../components/profile-popup';
import { ProfileImage } from '../components/profile-image';
import Section from '../components/work/section.astro';
import { constructChatdbUrl } from '../lib/construct-chatdb-url';

export const prerender = true;
---

<Layout>
  <div class="relative w-full bg-background flex flex-col">
    <div class="mt-8 sm:mt-12 lg:mt-24 mx-3 sm:mx-12 lg:mx-24 flex flex-col space-y-8">
      <!-- Header that transitions on scroll - STICKY -->
      <div
        id="header-container"
        class="sticky top-0 bg-background z-10 flex flex-col pb-4"
        style="transition: all 0.3s ease;"
      >
        <div
          id="fullstack-label"
          class="font-mono border-l border-muted-foreground/30 text-muted-foreground/80 text-sm flex px-4 sm:px-8 items-center gap-2 mb-2"
          style="transition: all 0.3s ease;"
        >
          <Icon name="squareStackUp" className="size-4 text-muted-foreground/80" />
          <p class="hidden sm:block">Fullstack Software Engineer</p>
          <p class="block sm:hidden">Fullstack SWE</p>
        </div>

        <div
          id="header-content"
          class="flex relative items-start gap-4 justify-between mt-8 px-4 sm:px-8 border-l border-r border-muted-foreground/30"
        >
          <div class="flex flex-col">
            <div class="flex items-center gap-2 sm:gap-4">
              <h1 class="font-semibold text-xl md:text-3xl text-muted-foreground">Alex Godfrey</h1>
              <ProfileImage client:load />
            </div>

            <!-- Description paragraphs - fade out on scroll -->
            <div
              id="description-text"
              class="overflow-hidden flex flex-col gap-1 my-2"
              style="transition: all 0.3s ease;"
            >
              <p class="hidden sm:block font-medium text-muted-foreground/80 text-sm sm:text-base">
                Formally trained in mathematics, computer science, and neuroscience.
              </p>
              <p class="sm:hidden font-medium text-muted-foreground/80 text-sm sm:text-base">
                Formally trained in math, cs, and neuro.
              </p>
              <p class="font-medium text-muted-foreground/80 text-sm sm:text-base">
                Focused on engineering solutions for longevity.
              </p>
            </div>

            <!-- Buttons - initially below description -->
            <div
              id="action-buttons"
              class="flex mt-1 gap-4 items-center"
              style="transition: all 0.3s ease;"
            >
              <WorkPopupTrigger client:load />
              <ContactPopupTrigger client:load />
            </div>

            <!-- Skills sidebar - fade out on scroll -->
            <div
              id="skills-sidebar"
              class="absolute right-2 top-0 bottom-0 flex flex-col-reverse items-center justify-around"
              style="transition: opacity 0.3s ease;"
            >
              <Logo name={Logos.PostgreSQL} className="size-4" />
              <Logo name={Logos.AWS} className="size-4" />
              <Logo name={Logos.Astro} className="size-4" />
              <Logo name={Logos.Next} className="size-4" />
              <Logo name={Logos.Tailwind} className="size-4" />
              <Logo name={Logos.React} className="size-4" />
              <Logo name={Logos.TypeScript} className="size-4" />
            </div>
            <p
              id="skills-label"
              class="hidden uppercase sm:block absolute -right-9.5 top-1/2 mb-4 -translate-y-1/2 rotate-90 font-mono text-muted-foreground/80 text-sm"
              style="transition: opacity 0.3s ease;"
            >
              Skills
            </p>
          </div>

          <!-- Buttons container for scrolled state -->
          <div
            id="action-buttons-right"
            class="flex flex-col gap-2 items-end pointer-events-none absolute right-4 top-0 lg:static lg:right-auto lg:top-auto"
            style="opacity: 0; transition: all 0.3s ease;"
          >
            <WorkPopupTrigger client:load />
            <ContactPopupTrigger client:load />
          </div>
        </div>
      </div>

      <div class="px-4 sm:px-8 sm:mt-12 border-l border-r border-muted-foreground/30 grid-rows-3">
        <div class="grid grid-cols-1 lg:grid-cols-3 border">
          <div class="flex flex-col col-span-2 lg:border-r border-b lg:border-b-0">
            <div class="border-b">
              <a
                href="#onetwentyone-section"
                class="block focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-foreground"
                aria-label="Jump to OneTwentyOne section"
              >
                <HumidityCard />
              </a>
            </div>
            <!-- <Co2Card /> -->
            <a
              href="#onetwentyone-section"
              class="block focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-foreground"
              aria-label="Jump to OneTwentyOne section"
            >
              <RadonCard />
            </a>
          </div>
          <div class="h-40 flex w-full">
            <div class="w-full"><BlogPreviewCard slug="red-bull" /></div>
            <!-- <BlogPreviewCard slug="sync-engine" /> -->
          </div>
        </div>
        <div class="grid grid-col-1 lg:grid-cols-5 border-b border-r border-l">
          <div class="lg:border-r col-span-2 grid grid-rows-2">
            <a
              href="/resources/Letter%20of%20rec%20for%20Alex.pdf"
              target="_blank"
              rel="noreferrer"
              class="block border-b lg:border-b-0 h-full focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-foreground"
              aria-label="Read letter of recommendation"
            >
              <BenjiQuote />
            </a>
            <a
              href="https://thiscellpaintingdoesnotexist.com"
              target="_blank"
              rel="noreferrer"
              class="border-b lg:border-b-0 flex flex-col items-center justify-center focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-foreground"
              aria-label="Visit This Cell Painting Does Not Exist"
            >
              <CellPaintVideo />
            </a>
          </div>
          <div class="col-span-2">
            <div class="">
              <a
                href="#onetwentyone-section"
                class="block focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-foreground"
                aria-label="Jump to OneTwentyOne section"
              >
                <img src="/images/conquer-biomark.png" alt="Conquer Biomark" />
              </a>
            </div>
            <div
              class="h-64 border-t relative flex flex-col items-center justify-center overflow-y-hidden"
            >
              <iframe
                src={constructChatdbUrl({
                  appId: 'a2c51623-badd-4ef2-a830-e7c39a1df343',
                  chartId: 'c0cc3173-c19d-47e0-9683-bdee32d9356c',
                  hideHeader: false,
                  hideFooter: true,
                  hideTitle: false,
                  hideXAxis: false,
                  hideYAxis: false,
                })}
                title="Top 10 Most Observed Crocodile Species"
                loading="lazy"
                style="border:0;width:100%;height:100%;display:block;overflow-y:hidden;"
                allow="clipboard-read; clipboard-write"></iframe>
              <a
                href="https://www.chatdb.io/apps/a2c51623-badd-4ef2-a830-e7c39a1df343"
                rel="noreferrer"
                class="absolute inset-0 z-10"
                aria-label="Open ChatDB"></a>
            </div>
          </div>
          <div class="hidden lg:block border-l">
            <a
              href="#onetwentyone-section"
              class="block h-full focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-foreground"
              aria-label="Jump to OneTwentyOne section"
            >
              <img
                src="/images/121health.webp"
                alt="121 Health interface"
                class="object-cover h-full w-full"
              />
            </a>
          </div>
        </div>
      </div>

      <div class="grid grid-rows-[auto_1fr] mt-8 lg:mt-24">
        <div class="relative">
          <SHV />
          <OneTwentyOne />
          <Altum />
        </div>
      </div>
    </div>
    <div class="pb-16 lg:pb-0 dither-lg md:dither-2xl">
      <h1
        class="font-mono font-bold text-[5rem] md:text-[16rem] text-muted-foreground uppercase text-center"
      >
        Godfrey
      </h1>
    </div>
    <!-- <MasonryGrid cells={cells} className="p-2" columns={4} gap={8} /> -->
    <!-- <ProfileCard /> -->
  </div>
  <div class="fixed bottom-4 left-[calc(50%-6rem)] z-[99999999]">
    <HumanOrMachine defaultValue="human" machineLink="/blog/ai" humanLink="/" client:load />
  </div>
  <ContactPopup client:load />
  <ProfilePopup client:load />

  <script>
    let rafId: number;
    type RgbaColor = { r: number; g: number; b: number; a: number };

    let headerContainer: HTMLElement | null = null;
    let fullstackLabel: HTMLElement | null = null;
    let descriptionText: HTMLElement | null = null;
    let actionButtons: HTMLElement | null = null;
    let actionButtonsRight: HTMLElement | null = null;
    let skillsSidebar: HTMLElement | null = null;
    let skillsLabel: HTMLElement | null = null;

    const viewport = window.innerWidth;
    let initialBorderColor: string | null = null;
    let borderColorChannels: RgbaColor | null = null;
    let descriptionMaxHeight = 80;

    const assignElements = () => {
      headerContainer = document.getElementById('header-container');
      fullstackLabel = document.getElementById('fullstack-label');
      descriptionText = document.getElementById('description-text');
      actionButtons = document.getElementById('action-buttons');
      actionButtonsRight = document.getElementById('action-buttons-right');
      skillsSidebar = document.getElementById('skills-sidebar');
      skillsLabel = document.getElementById('skills-label');
      initialBorderColor = null;
      borderColorChannels = null;
      if (descriptionText) {
        descriptionMaxHeight = descriptionText.scrollHeight;
      }
    };

    assignElements();

    const ensureBorderColor = () => {
      if (borderColorChannels || !fullstackLabel) {
        return;
      }

      const computed = getComputedStyle(fullstackLabel).borderLeftColor;
      initialBorderColor = computed;
      const match = computed.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([0-9.]+))?\)/);

      if (!match) {
        return;
      }

      borderColorChannels = {
        r: Number(match[1]),
        g: Number(match[2]),
        b: Number(match[3]),
        a: match[4] !== undefined ? Number(match[4]) : 1,
      };
    };

    const setBorderOpacity = (opacity: number) => {
      ensureBorderColor();

      if (!borderColorChannels || !fullstackLabel) {
        return;
      }

      const clamped = Math.max(0, Math.min(opacity, 1));
      const alpha = clamped * borderColorChannels.a;

      fullstackLabel.style.borderLeftColor = `rgba(${borderColorChannels.r}, ${borderColorChannels.g}, ${borderColorChannels.b}, ${alpha})`;
    };

    const updateHeader = () => {
      const scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;

      const triggerPoint = 25;
      const transitionDuration = 25;

      const progress = Math.min(Math.max((scrollY - triggerPoint) / transitionDuration, 0), 1);

      if (
        !headerContainer ||
        !fullstackLabel ||
        !descriptionText ||
        !actionButtons ||
        !actionButtonsRight ||
        !skillsSidebar ||
        !skillsLabel
      ) {
        assignElements();
        if (
          !headerContainer ||
          !fullstackLabel ||
          !descriptionText ||
          !actionButtons ||
          !actionButtonsRight ||
          !skillsSidebar ||
          !skillsLabel
        ) {
          return;
        }
      }

      ensureBorderColor();

      if (progress > 0) {
        headerContainer.style.paddingTop = `${16 - 8 * progress}px`;
        headerContainer.style.paddingBottom = `${16 - 12 * progress}px`;

        descriptionText.style.opacity = `${1 - progress}`;
        descriptionText.style.maxHeight = `${descriptionMaxHeight * (1 - progress)}px`;

        skillsSidebar.style.opacity = `${1 - progress}`;
        skillsLabel.style.opacity = `${1 - progress}`;

        fullstackLabel.style.transform = `translateY(${progress * 102}px)`;
        fullstackLabel.style.marginBottom = `${8 * (1 - progress)}px`;
        fullstackLabel.style.marginTop = `${-42 * progress}px`;
        // remove left border
        fullstackLabel.style.borderLeft = 'none';

        setBorderOpacity(1 - progress * 2);

        actionButtons.style.opacity = `${1 - progress}`;
        actionButtons.style.pointerEvents = progress > 0.5 ? 'none' : 'auto';
        actionButtonsRight.style.opacity = `${progress}`;
        actionButtonsRight.style.pointerEvents = progress > 0.5 ? 'auto' : 'none';
      } else {
        headerContainer.style.paddingTop = '16px';
        headerContainer.style.paddingBottom = '16px';
        descriptionText.style.opacity = '1';
        descriptionText.style.maxHeight = `${descriptionMaxHeight}px`;
        skillsSidebar.style.opacity = '1';
        skillsLabel.style.opacity = '1';
        fullstackLabel.style.transform = 'translateY(0)';
        fullstackLabel.style.marginTop = '0';
        // add the border back for the fullstack label
        fullstackLabel.style.borderLeft = '1px solid #c2c2c2';
        fullstackLabel.style.paddingLeft = viewport < 640 ? '16px' : '32px';
        fullstackLabel.style.marginBottom = '8px';
        actionButtons.style.opacity = '1';
        actionButtons.style.pointerEvents = 'auto';
        actionButtonsRight.style.opacity = '0';
        actionButtonsRight.style.pointerEvents = 'none';
      }
    };

    const onScroll = () => {
      if (rafId) {
        cancelAnimationFrame(rafId);
      }
      rafId = requestAnimationFrame(updateHeader);
    };

    // Listen to all possible scroll events
    window.addEventListener('scroll', onScroll, { passive: true });
    document.addEventListener('scroll', onScroll, { passive: true });

    // Handle Astro view transitions
    const reinitializeHeader = () => {
      assignElements();
      updateHeader();
    };

    document.addEventListener('astro:after-swap', reinitializeHeader);
    document.addEventListener('astro:page-load', reinitializeHeader);

    // Initial call
    updateHeader();
  </script>
</Layout>
